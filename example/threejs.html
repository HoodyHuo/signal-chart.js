<!DOCTYPE html>
<html>

<head>
    <meta charset='utf-8'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <title>Page Title</title>
    <script src="axios.js"></script>
    <style>
        .cont{
            height: 800px;
            width: 1000px;
            background-color: bisque;
        }
    </style>
</head>

<body>
    <button onclick="setMode(0)">刷新模式</button>
    <button onclick="setMode(1)">最大保持</button>
    <button onclick="setMode(2)">最小保持</button>
    <button onclick="setMode(3)">平均</button>
    <button onclick="getBorder()">边框数据</button>

    <div id="cont" class="cont" ></div>
    <script type="module" >
        
        import {Spectrogram} from '../lib/signal-chart.js'
        const MAX_POINTS  = 4800
        const gram = new Spectrogram({
            keepMode: 0, // 保持模式 0 刷新 1 最大 2 最小 3 平均
            
            cacheCount: 500,
            Performance: true, // 是否打开性能监视窗口
            El: document.getElementById("cont"), // 图形绘制节点 
            color:{
                background:'#ffffff',
                line:"#000000",
            }
        })

        document.getElementById('cont')
        .addEventListener('mousemove',(event)=>{
            console.log(gram.getPointValue(event.offsetX,event.offsetY))
            if(event.altKey){
                const c = gram.getProject()
            }
            if(event.ctrlKey){
                gram.move({x:-event.movementX,y:event.movementY})
            }
            
        })
        let sc = 1
        function getScale(b){
            if(b>0){
                sc-=0.3
            }else{
                sc+=0.3
            }

            if(sc<=0.1){
                sc = 0.1
            }
            return sc
        }


        document.getElementById('cont')
        .addEventListener('mousewheel',(event)=>{
            const old = gram.threeLayer.camera.scale
            gram.threeLayer.camera.scale.set(getScale(event.deltaY),old.y,old.z)
            // gram.scale(event.deltaY)
            
        })

     
        window.setMode = function(mode){
            gram.setKeepMode(mode)
        }

        window.getBorder = function(){
            const v = gram.getBorderValue()
            console.log(v)
        }
        //设置当前图谱的频率范围
        gram.setFreqRange(0,4800)
        //设置可视区域的范围
        gram.setViewFreqRange(0,3000)
        gram.setViewLevelRange(-120,-20)

        // animate
        axios.get('./fftData-4.dat', { responseType: 'arraybuffer' }).then(res => {
                const bitData = res.data
                // 取出1000帧
                // const dv = new DataView(bitData)
                // const float32Arr = new Float32Array(bitData.byteLength/4)
                // for(let i = 0;i<bitData.byteLength/4;i++){
                //     const b  =  dv.getFloat32(i*4,false) 
                //     float32Arr[i] = b
                // }

                gram.setFreqRange(0,9600/2)
                const float32Arr = new Float32Array(bitData)
                let index = 0
                setInterval(function () {
                    // 如果下标超出数据范围，重新移动到0
                    if (index + MAX_POINTS > float32Arr.length) {
                        index = 0
                    }
                    // 根据下标，从总数据包中取出接下来的一段，因为数据包含XYZ，所以长度要取 3倍
                    const data = float32Arr.slice(index, index + MAX_POINTS )
                    gram.update(data)
                    //取数下标更新
                    index += MAX_POINTS
                    
                }, 1000/10)

            })
        
             
    </script>

</body>

</html>